<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockWare - Reporte de Campo</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --bg: #f4f7f6;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 10px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .logo {
            text-align: center;
            font-size: 22px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .section-title {
            background: #f8f9fa;
            padding: 10px;
            border-left: 5px solid var(--accent);
            font-weight: bold;
            margin: 20px 0 10px;
            font-size: 14px;
            text-transform: uppercase;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 13px;
        }

        select,
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .material-list {
            margin-top: 10px;
        }

        .material-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }

        .material-item.disabled {
            opacity: 0.3;
            background: #fafafa;
            filter: grayscale(1);
            pointer-events: none;
        }

        .material-info {
            flex: 1;
            padding-right: 15px;
        }

        .material-name {
            font-weight: bold;
            font-size: 14px;
            display: block;
        }

        .material-sku {
            font-size: 11px;
            color: #777;
        }

        .material-qty {
            width: 80px !important;
            text-align: center;
            border-color: #bbb;
        }

        .submit-btn {
            width: 100%;
            padding: 18px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            box-shadow: none;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hint {
            font-size: 11px;
            color: #666;
            font-weight: normal;
            margin-top: 3px;
            display: block;
        }

        /* Scanner Modal */
        .scan-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .scan-modal.active {
            display: flex;
        }

        .scan-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 80%;
        }

        .scan-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin-left: 10px;
            padding: 5px;
            opacity: 0.7;
            transition: transform 0.2s;
        }

        .scan-icon-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .highlight-row {
            animation: flash 1s;
        }

        @keyframes flash {
            0% {
                background-color: #d4edda;
            }

            100% {
                background-color: transparent;
            }
        }
    </style>
</head>

<body>
    <!-- Scan Modal -->
    <div class="scan-modal" id="scanModal">
        <div class="scan-content">
            <div style="font-size: 50px;">üì∑</div>
            <h2>Escanee el C√≥digo Ahora</h2>
            <p id="scanTargetName" style="color: var(--accent); font-weight: bold;">...</p>
            <input type="text" id="modalScanInput" style="opacity: 0; position: absolute; pointer-events: none;">
            <p style="font-size: 12px; color: #666;">Esperando lectura de c√≥digo de barras...</p>
            <button onclick="closeScanner()"
                style="margin-top:20px; padding:10px 20px; border:none; background:#eee; border-radius:5px;">Cancelar</button>
        </div>
    </div>

    <!-- Modal de Selecci√≥n de Seriales (NUEVO) -->
    <div class="scan-modal" id="modalSeriales">
        <div class="scan-content" style="max-width:450px; max-height:90vh; overflow-y:auto;">
            <h2 id="modalSeriesTitulo" style="margin-top:0; color:var(--primary);"></h2>
            <p style="color:#666; font-size:13px; margin-bottom:15px;">Seleccione los equipos utilizados:</p>

            <div id="listaSeriales"
                style="max-height:350px; overflow-y:auto; margin:15px 0; border:1px solid #ddd; border-radius:8px; background:#fafafa;">
                <!-- Checkboxes din√°micos -->
            </div>

            <p style="font-weight:bold; font-size:16px; margin-top:15px;">
                Seleccionados: <span id="countSeleccionados" style="color:var(--success);">0</span>
            </p>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="confirmarSeriales()"
                    style="flex:1; padding:12px 20px; background:var(--success); color:white; border:none; border-radius:8px; font-size:14px; font-weight:bold; cursor:pointer;">
                    ‚úÖ Confirmar
                </button>
                <button onclick="cerrarModalSeriales()"
                    style="flex:1; padding:12px 20px; background:#95a5a6; color:white; border:none; border-radius:8px; font-size:14px; cursor:pointer;">
                    ‚ùå Cancelar
                </button>
            </div>
        </div>
    </div>

    <div class="logo">üöÄ StockWare</div>
    <div style="text-align:center; margin-bottom:10px;">
        <a href="/auditoria"
            style="display:inline-block; background:#2c3e50; color:#3498db; border:1px solid #3498db; padding:8px 20px; border-radius:8px; font-size:13px; font-weight:600; text-decoration:none;">
            üìã Auditor√≠a de Terreno y Retorno
        </a>
    </div>
    <div class="container">
        <h1>Reporte de Consumo</h1>

        <div class="alert {% if db_status == 'OK' %}alert-success{% else %}alert-error{% endif %}"
            style="display: block; margin-bottom: 20px;">
            <b>ESTADO:</b> {{ db_status }}<br>
            <b>DATOS:</b> {{ count_m }} M√≥viles, {{ count_p }} Productos<br>
            <small><b>Motor:</b> {{ db_engine }}</small>
            {% if error_detail %}
            <br><small><b>Error:</b> {{ error_detail }}</small>
            {% endif %}
        </div>

        <div id="alert" class="alert"></div>

        <form id="consumoForm">
            <div class="section-title">Datos de la Operaci√≥n</div>
            <div class="form-group">
                <label>Fecha:</label>
                <input type="date" name="fecha" value="{{ hoy }}" required>
            </div>
            <div class="form-group">
                <label>N¬∞ Colilla: <span class="hint">(Debe empezar con PAA)</span></label>
                <input type="text" name="colilla" id="colilla" placeholder="Ej: PAA123" required>
            </div>
            <div class="form-group">
                <label>N¬∞ Contrato: <span class="hint">(Debe empezar con P-)</span></label>
                <input type="text" name="contrato" id="contrato" placeholder="Ej: P-456" required>
            </div>
            <div class="form-group">
                <label>M√≥vil / Veh√≠culo:</label>
                <select name="movil" id="movil_select" required>
                    <option value="">--- Seleccionar ---</option>
                    {% for movil in moviles %}
                    <option value="{{ movil }}">{{ movil }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" id="group_paquete" style="display:none;">
                <label>Paquete de Trabajo: <span class="hint">(Seleccione el paquete que est√° reportando
                        hoy)</span></label>
                <select name="paquete" id="paquete_select">
                    <option value="PAQUETE A">PAQUETE A</option>
                    <option value="PAQUETE B">PAQUETE B</option>
                </select>
            </div>

            <div class="form-group">
                <label>T√©cnico (Conductor):</label>
                <input type="text" name="tecnico" id="tecnico" required>
            </div>
            <div class="form-group">
                <label>Ayudante:</label>
                <input type="text" name="ayudante" id="ayudante">
            </div>

            <div class="section-title" id="section_materiales" style="display:none;">üì¶ Materiales Asignados al M√≥vil
            </div>

            <!-- Mensaje inicial -->
            <div id="mensaje_seleccionar"
                style="text-align:center; padding:40px 20px; color:#666; background:#f8f9fa; border-radius:8px; margin:15px 0;">
                <div style="font-size:40px; margin-bottom:10px;">üöö</div>
                <p style="font-weight:bold; font-size:16px; margin:0;">Seleccione un M√≥vil</p>
                <p style="font-size:13px; margin-top:5px;">Se mostrar√°n los materiales asignados a esa unidad</p>
            </div>

            <!-- Lista din√°mica de materiales -->
            <div class="material-list" id="material_list_container" style="display:none;">
                <!-- Se genera din√°micamente por JavaScript -->
            </div>

            <!-- Mensaje cuando no hay stock -->
            <div id="mensaje_sin_stock"
                style="display:none; text-align:center; padding:30px 20px; color:#e74c3c; background:#fef0f0; border-radius:8px; margin:15px 0;">
                <div style="font-size:40px; margin-bottom:10px;">üì≠</div>
                <p style="font-weight:bold; font-size:16px; margin:0;">Sin materiales asignados</p>
                <p style="font-size:13px; margin-top:5px;">Este m√≥vil no tiene materiales en inventario</p>
            </div>

            <button type="submit" class="submit-btn" id="submit_btn">Enviar Reporte Final üì§</button>
        </form>

        <div
            style="margin-top: 40px; padding: 10px; border-top: 1px solid #ddd; font-size: 11px; color: #999; text-align: center;">
            STOCKWARE CLOUD | {{ db_engine }} | M√ìVILES: {{ count_m }} | PRODUCTOS: {{ count_p }}
        </div>
    </div>

    <script>
        const DETAILS_MOVILES = {{ details_moviles | safe }};
        const SKU_TO_EXCEL_NAME = {{ sku_to_excel_name | safe }};
        const MATERIALES_COMPARTIDOS = {{ materiales_compartidos | safe }};

        // Estado global
        window.INVENTARIO_MOVIL = [];   // Array de items del inventario de la m√≥vil
        window.SERIALES_SELECCIONADOS = {};  // {sku: [seriales]}

        // ‚îÄ‚îÄ Al seleccionar m√≥vil ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('movil_select').onchange = async function () {
            const movil = this.value;

            // Reset seriales y lista
            window.SERIALES_SELECCIONADOS = {};
            document.getElementById('group_paquete').style.display = 'none';

            // Auto-completar conductor/ayudante
            try {
                const d = DETAILS_MOVILES[movil];
                if (d) {
                    document.getElementById('tecnico').value = d.conductor || '';
                    document.getElementById('ayudante').value = d.ayudante || '';
                }
            } catch (e) { console.error('Autocompletado:', e); }

            if (!movil) {
                document.getElementById('material_list_container').style.display = 'none';
                document.getElementById('mensaje_seleccionar').style.display = 'block';
                document.getElementById('mensaje_sin_stock').style.display = 'none';
                document.getElementById('section_materiales').style.display = 'none';
                return;
            }

            // Mostrar loading
            document.getElementById('mensaje_seleccionar').style.display = 'none';
            document.getElementById('mensaje_sin_stock').style.display = 'none';
            document.getElementById('material_list_container').innerHTML =
                '<p style="text-align:center;padding:20px;color:#666;">‚è≥ Cargando inventario...</p>';
            document.getElementById('material_list_container').style.display = 'block';

            try {
                const res = await fetch(`/api/inventario/${encodeURIComponent(movil)}`);
                const data = await res.json();
                window.INVENTARIO_MOVIL = data.inventario || [];
            } catch (e) {
                console.error('Error cargando inventario:', e);
                window.INVENTARIO_MOVIL = [];
            }

            // Mostrar selector de paquete y renderizar con el paquete actual
            document.getElementById('group_paquete').style.display = 'block';
            renderizarInventario();
        };

        // ‚îÄ‚îÄ Al cambiar paquete, re-renderizar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.getElementById('paquete_select').onchange = function () {
            window.SERIALES_SELECCIONADOS = {}; // Reset selecci√≥n al cambiar paquete
            renderizarInventario();
        };

        // ‚îÄ‚îÄ Renderizar lista filtrada por paquete seleccionado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ‚îÄ‚îÄ Renderizar lista filtrada por paquete seleccionado ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderizarInventario() {
            try {
                const container = document.getElementById('material_list_container');
                const mensajeSinStock = document.getElementById('mensaje_sin_stock');
                const sectionTitle = document.getElementById('section_materiales');

                if (!container) return;
                container.innerHTML = '';

                const selectPaquete = document.getElementById('paquete_select');
                const paqueteSeleccionado = selectPaquete ? selectPaquete.value : 'PAQUETE A';

                const inventario = window.INVENTARIO_MOVIL || [];
                const compartidosCheck = window.MATERIALES_COMPARTIDOS || [];

                // --- L√ìGICA DE AGREGACI√ìN Y PUENTE (PERSONALIZADO) ---

                // 1. Items espec√≠ficos del paquete (No compartidos)
                const itemsEspecificos = inventario.filter(item => {
                    const pq = (item.paquete || 'NINGUNO').toUpperCase();
                    return pq === paqueteSeleccionado.toUpperCase() && !compartidosCheck.includes(item.sku);
                });

                // 2. Items Puente (Personalizado/Ninguno que no sean del paquete actual)
                const itemsPuente = inventario.filter(item => {
                    const pq = (item.paquete || 'NINGUNO').toUpperCase();
                    return (pq === 'PERSONALIZADO' || pq === 'NINGUNO') &&
                        pq !== paqueteSeleccionado.toUpperCase() &&
                        !compartidosCheck.includes(item.sku);
                });

                // 3. Agregados (Compartidos Globales)
                const mapCompartidos = {};
                inventario.forEach(item => {
                    if (compartidosCheck.includes(item.sku)) {
                        if (!mapCompartidos[item.sku]) {
                            mapCompartidos[item.sku] = JSON.parse(JSON.stringify(item));
                            mapCompartidos[item.sku].paquete = 'COMPARTIDO';
                            mapCompartidos[item.sku].cantidad_total = 0;
                            mapCompartidos[item.sku].seriales = [];
                        }
                        mapCompartidos[item.sku].cantidad_total += (parseFloat(item.cantidad_total) || 0);
                        if (item.seriales && Array.isArray(item.seriales)) {
                            item.seriales.forEach(s => {
                                if (!mapCompartidos[item.sku].seriales.includes(s)) {
                                    mapCompartidos[item.sku].seriales.push(s);
                                }
                            });
                        }
                    }
                });
                const itemsCompartidos = Object.values(mapCompartidos);

                // Combinaci√≥n: Propios + Puente + Compartidos
                const items = itemsEspecificos.concat(itemsPuente).concat(itemsCompartidos);

                if (items.length === 0) {
                    container.style.display = 'none';
                    sectionTitle.style.display = 'none';
                    mensajeSinStock.style.display = 'block';
                    mensajeSinStock.innerHTML = `
                        <div style="font-size:32px;margin-bottom:8px;">üì≠</div>
                        <p style="font-weight:bold;margin:0;">Sin materiales disponibles</p>
                        <p style="font-size:13px;margin-top:5px;color:#888;">Este m√≥vil no tiene materiales en ${paqueteSeleccionado} o Personalizado</p>
                    `;
                    return;
                }

                mensajeSinStock.style.display = 'none';
                sectionTitle.style.display = 'block';
                sectionTitle.textContent = `üì¶ Materiales del ${paqueteSeleccionado}`;
                container.style.display = 'block';

                items.forEach(item => {
                    const nombreCorto = SKU_TO_EXCEL_NAME[item.sku] || item.nombre;
                    const disponibles = item.tiene_series ? (item.seriales ? item.seriales.length : 0) : item.cantidad_total;

                    const row = document.createElement('div');
                    row.className = 'material-item';
                    row.id = `row_${item.sku}`;
                    if (disponibles === 0) row.classList.add('disabled');

                    row.innerHTML = `
                        <div class="material-info">
                            <span class="material-name">${nombreCorto}</span>
                            <span class="material-sku">SKU: ${item.sku}</span>
                            <span class="badge-disponible" style="background:${disponibles > 0 ? '#3498db' : '#e74c3c'}; color:white; padding:3px 8px; border-radius:10px; font-size:11px; margin-left:8px; display:inline-block;">
                                üöö ${disponibles} en m√≥vil
                            </span>
                        </div>
                    `;

                    const inputContainer = document.createElement('div');
                    inputContainer.style.cssText = 'display:flex; align-items:center;';

                    if (item.tiene_series) {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.id = `btn_${item.sku}`;
                        btn.className = 'btn-seleccionar-series';
                        btn.textContent = disponibles > 0 ? 'Seleccionar' : 'Sin stock';
                        btn.disabled = disponibles === 0;
                        btn.onclick = () => abrirModalSeriales(item.sku, nombreCorto, item.seriales || []);
                        btn.style.cssText = `padding:10px 20px; background:${disponibles > 0 ? '#27ae60' : '#ccc'}; color:white; border:none; border-radius:6px; font-size:13px; font-weight:bold; cursor:${disponibles > 0 ? 'pointer' : 'not-allowed'};`;
                        inputContainer.appendChild(btn);

                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = `qty_${item.sku}`;
                        hiddenInput.id = `input_${item.sku}`;
                        hiddenInput.className = 'sku-input';
                        hiddenInput.value = '0';
                        inputContainer.appendChild(hiddenInput);
                    } else {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.name = `qty_${item.sku}`;
                        input.id = `input_${item.sku}`;
                        input.className = 'material-qty sku-input';
                        input.dataset.sku = item.sku;
                        input.dataset.name = nombreCorto;
                        input.min = '0';
                        input.max = disponibles.toString();
                        input.placeholder = '0';
                        input.disabled = disponibles === 0;
                        input.addEventListener('input', function () {
                            const val = parseInt(this.value) || 0;
                            if (val > disponibles) {
                                this.value = disponibles;
                                this.style.borderColor = 'red';
                                setTimeout(() => this.style.borderColor = '#ddd', 500);
                            }
                        });
                        inputContainer.appendChild(input);
                    }
                    row.appendChild(inputContainer);
                    container.appendChild(row);
                });
            } catch (err) {
                console.error("Error en renderizado:", err);
            }
        }


        // ========== FUNCIONES PARA MODAL DE SELECCI√ìN DE SERIALES ==========

        let currentModalSKU = null;
        let currentModalSeriales = null;

        function abrirModalSeriales(sku, nombre, seriales) {
            currentModalSKU = sku;
            currentModalSeriales = seriales;

            document.getElementById('modalSeriesTitulo').textContent = nombre;

            const lista = document.getElementById('listaSeriales');
            lista.innerHTML = '';

            if (!seriales || seriales.length === 0) {
                lista.innerHTML = '<p style="padding:20px;text-align:center;color:#999;">Sin seriales disponibles en esta m√≥vil</p>';
                actualizarContadorSeriales();
                document.getElementById('modalSeriales').classList.add('active');
                return;
            }

            // Obtener selecci√≥n actual (llave simple por SKU)
            const seleccionados = window.SERIALES_SELECCIONADOS[sku] || [];

            // Crear checkboxes para cada serial
            seriales.forEach((serial) => {
                const label = document.createElement('label');
                label.style.cssText = 'display:block; padding:12px 15px; border-bottom:1px solid #e0e0e0; cursor:pointer; transition:background 0.2s;';
                label.onmouseover = () => label.style.background = '#f0f0f0';
                label.onmouseout = () => label.style.background = 'transparent';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = serial;
                checkbox.checked = seleccionados.includes(serial);
                checkbox.onchange = actualizarContadorSeriales;
                checkbox.style.marginRight = '10px';

                const serialText = document.createElement('span');
                serialText.textContent = serial;
                serialText.style.fontFamily = 'Courier, monospace';
                serialText.style.fontSize = '12px';

                label.appendChild(checkbox);
                label.appendChild(serialText);
                lista.appendChild(label);
            });

            actualizarContadorSeriales();
            document.getElementById('modalSeriales').classList.add('active');
        }

        function actualizarContadorSeriales() {
            const checked = document.querySelectorAll('#listaSeriales input:checked').length;
            document.getElementById('countSeleccionados').textContent = checked;
        }

        function confirmarSeriales() {
            const checkboxes = document.querySelectorAll('#listaSeriales input:checked');
            const seleccionados = Array.from(checkboxes).map(cb => cb.value);

            // Guardar selecci√≥n con llave simple por SKU
            window.SERIALES_SELECCIONADOS[currentModalSKU] = seleccionados;

            // Actualizar input oculto con cantidad
            const input = document.getElementById(`input_${currentModalSKU} `);
            if (input) {
                input.value = seleccionados.length;
            }

            // Actualizar badge y bot√≥n en la fila
            const row = document.getElementById(`row_${currentModalSKU} `);
            const badge = row?.querySelector('.badge-disponible');
            if (badge && currentModalSeriales) {
                const restantes = currentModalSeriales.length - seleccionados.length;
                badge.textContent = `üöö ${restantes} en m√≥vil`;
                badge.style.background = restantes > 0 ? '#3498db' : '#e74c3c';
            }
            const btn = row?.querySelector('.btn-seleccionar-series');
            if (btn) {
                btn.textContent = seleccionados.length > 0 ? `‚úÖ ${seleccionados.length} seleccionados` : 'Seleccionar';
            }

            cerrarModalSeriales();
        }

        function cerrarModalSeriales() {
            document.getElementById('modalSeriales').classList.remove('active');
            currentModalSKU = null;
            currentModalSeriales = null;
        }

        // ========== FIN FUNCIONES DE MODAL ==========

        document.getElementById('consumoForm').onsubmit = async (e) => {
            e.preventDefault();
            const alert = document.getElementById('alert');
            const submitBtn = document.getElementById('submit_btn');

            const colilla = document.getElementById('colilla').value.toUpperCase().trim();
            const contrato = document.getElementById('contrato').value.toUpperCase().trim();

            if (!colilla.startsWith('PAA')) { alert.style.display = 'block'; alert.className = 'alert alert-error'; alert.innerText = '‚ùå Colilla debe iniciar con PAA'; return; }
            if (!contrato.startsWith('P-')) { alert.style.display = 'block'; alert.className = 'alert alert-error'; alert.innerText = '‚ùå Contrato debe iniciar con P-'; return; }

            const materiales = [];
            document.querySelectorAll('.sku-input').forEach(i => {
                const v = parseInt(i.value);
                if (v > 0) {
                    const material = { sku: i.dataset.sku, cantidad: v };

                    // Agregar seriales si fueron seleccionados (llave simple por SKU)
                    const seriales = window.SERIALES_SELECCIONADOS[i.dataset.sku];
                    if (seriales && seriales.length > 0) {
                        material.seriales = seriales;
                    }

                    materiales.push(material);
                }
            });

            if (materiales.length === 0) { alert.style.display = 'block'; alert.className = 'alert alert-error'; alert.innerText = '‚ùå Ingrese al menos un material.'; return; }

            submitBtn.disabled = true;
            submitBtn.innerText = 'Enviando...';

            const fd = new FormData(e.target);
            const payload = {
                fecha: fd.get('fecha'),
                colilla: colilla,
                contrato: contrato,
                tecnico: fd.get('tecnico'),
                ayudante: fd.get('ayudante'),
                movil: fd.get('movil'),
                paquete: document.getElementById('paquete_select').value,
                materiales: materiales
            };

            try {
                const res = await fetch('/registrar_bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                alert.style.display = 'block';
                if (data.exito) {
                    alert.className = 'alert alert-success'; alert.innerText = '‚úÖ Reporte enviado'; e.target.reset();
                    document.querySelectorAll('.material-item').forEach(r => r.classList.remove('disabled'));
                    document.querySelectorAll('input').forEach(i => i.disabled = false);
                } else {
                    alert.className = 'alert alert-error'; alert.innerText = '‚ùå Error: ' + data.mensaje;
                }
            } catch { alert.style.display = 'block'; alert.className = 'alert alert-error'; alert.innerText = '‚ùå Error de red'; }
            finally { submitBtn.disabled = false; submitBtn.innerText = 'Enviar Reporte Final üì§'; window.scrollTo(0, 0); }

        };

        // --- SCANNER LOGIC REFINED ---
        const ALLOWED_SKUS = [
            "U4-4-633", "4-4-644", "4-4-654", "4-4-656",
            "4-4-646", "4-4-647", "8-1-902", "8-1-903", "8-1-904"
        ];

        // 1. Show Scan Icons for Allowed SKUs
        ALLOWED_SKUS.forEach(sku => {
            const btn = document.getElementById('btn_scan_' + sku);
            if (btn) btn.style.display = 'inline-block';
        });

        // 2. Modal Logic
        const modal = document.getElementById('scanModal');
        const modalInput = document.getElementById('modalScanInput');
        let currentTargetSku = null;

        function openScanner(sku, name) {
            currentTargetSku = sku;
            document.getElementById('scanTargetName').innerText = name;
            modal.classList.add('active');
            modalInput.value = '';
            modalInput.focus(); // Focus hidden input to capture scan
        }

        function closeScanner() {
            modal.classList.remove('active');
            currentTargetSku = null;
        }

        // 3. Listen for Scan in Modal
        modalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleScanValues(modalInput.value.trim().toUpperCase());
            }
        });

        // Also listen on window for "background" scans if modal is open, 
        // in case focus was lost but regular scanner input is sent
        window.addEventListener('keydown', (e) => {
            if (modal.classList.contains('active') && e.target !== modalInput && e.target.tagName !== 'INPUT') {
                modalInput.focus();
            }
        });

        function handleScanValues(code) {
            if (!code) return;

            // Validate Match
            if (code !== currentTargetSku) {
                alert(`‚ùå C√≥digo incorrecto.Esperado: ${currentTargetSku}, Le√≠do: ${code} `);
                modalInput.value = '';
                return;
            }

            // Valid, Increment Logic
            const targetInput = document.getElementById('input_' + currentTargetSku);
            if (targetInput) {
                let currentVal = parseInt(targetInput.value) || 0;

                // Check Limit
                if (MAX_LIMITS[currentTargetSku] !== undefined && currentVal >= MAX_LIMITS[currentTargetSku]) {
                    alert(`‚ö†Ô∏è L√≠mite alcanzado para este equipo.`);
                    closeScanner();
                    return;
                }

                targetInput.value = currentVal + 1;
                targetInput.dispatchEvent(new Event('input')); // Trigger locks

                // Feedback
                const row = document.getElementById('row_' + currentTargetSku);
                row.classList.remove('highlight-row');
                void row.offsetWidth; // trigger reflow
                row.classList.add('highlight-row');

                closeScanner();
            }
        }

    </script>
</body>

</html>